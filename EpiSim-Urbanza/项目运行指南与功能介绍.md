# 流行病学建模项目 - 完整运行指南与功能介绍

## 📋 项目概述

**项目标题**: "接触减少、快速隔离和疫苗接种对城市疫情爆发动态影响的建模研究"

**核心创新**: 混合空间-行为模型，实现了从传统均匀混合SIR模型到空间异质性动态适应模型的重大突破。

## 🚀 快速开始

### 环境准备
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 验证安装
python -c "import numpy, pandas, matplotlib, seaborn; print('✅ 环境准备完成')"
```

### 一键运行
```bash
# 主要演示（推荐首次运行）
python demo.py

# 完整可视化生成
python run_all_visualizations.py

# 功能测试
python test_all_functions.py
```

## 🧬 核心模型详解

### 1. 基础SIR模型 (`src/models/sir_model.py`)

**功能**: 实现离散时间SIR传染病动力学模型

**核心代码**:
```python
from src.models.sir_model import SIRModel

# 创建模型
model = SIRModel(
    N=10000,      # 总人口
    beta=0.30,    # 接触率 (R0 = β/γ = 3.0)
    gamma=0.10,   # 恢复率 (平均感染期10天)
    I0=10,        # 初始感染者
    R0=0          # 初始恢复者
)

# 运行模拟
results = model.simulate(days=120)
print(f"感染峰值: {results['I_prop'].max():.3f}")
```

**输出结果**:
- `S_prop`: 易感者比例时间序列
- `I_prop`: 感染者比例时间序列  
- `R_prop`: 恢复者比例时间序列
- `day`: 时间步

### 2. SEIR扩展模型 (`src/models/seir_model.py`)

**功能**: 增加潜伏期compartment的SEIR模型

**核心代码**:
```python
from src.models.seir_model import SEIRModel

# 创建SEIR模型
model = SEIRModel(
    N=10000,
    beta=0.30,
    sigma=0.20,   # 潜伏期转换率 (平均潜伏期5天)
    gamma=0.10,
    I0=10,
    E0=0,         # 初始潜伏者
    R0=0
)

results = model.simulate(120)
```

**关键差异**: SEIR模型的感染峰值通常比SIR模型低35-40%，峰值时间延后。

### 3. 🔥 混合空间-行为模型 (`src/models/hybrid_model.py`)

**核心创新**: 项目最大亮点，结合空间异质性和动态行为适应

**功能特性**:
- **4个空间区域**: 城市核心、郊区、农村、工业区
- **动态行为适应**: 基于风险感知的接触率调整
- **区域间流动**: 人口在不同区域间的移动
- **阈值触发干预**: 自动激活行为改变

**核心代码**:
```python
from src.models.hybrid_model import HybridEpidemicModel

# 创建混合模型
model = HybridEpidemicModel(
    N=10000,
    n_zones=4,                    # 4个空间区域
    base_beta=0.30,
    base_gamma=0.10,
    adaptation_factor=0.5,        # 行为适应强度
    risk_threshold=0.05,          # 风险感知阈值
    I0=10,
    R0=0
)

# 运行模拟
results = model.simulate(120)

# 获取创新指标
innovation_metrics = model.get_innovation_metrics(results)
print(f"行为适应启动日: {innovation_metrics['behavioral_adaptation_day']}")
print(f"区域峰值异质性: {innovation_metrics['peak_heterogeneity']:.3f}")
```

**输出结果**:
```python
{
    'aggregate_results': DataFrame,      # 整体结果
    'zone_results': [DataFrame],         # 各区域结果
    'adaptation_history': DataFrame,     # 行为适应历史
    'zone_populations': [int],          # 各区域人口
    'final_sizes': [float]              # 各区域最终疫情规模
}
```

### 4. 网络传播模型 (`src/models/network_model.py`)

**功能**: 基于复杂网络的代理仿真

**支持网络类型**:
- **小世界网络**: 高聚类系数 + 短路径长度
- **无标度网络**: 幂律度分布
- **随机网络**: 泊松度分布

**核心代码**:
```python
from src.models.network_model import NetworkEpidemicModel

# 创建网络模型
model = NetworkEpidemicModel(
    N=1000,                    # 网络规模
    network_type='small_world', # 网络类型
    infection_prob=0.05,       # 感染概率
    recovery_prob=0.10,        # 恢复概率
    I0=5
)

results = model.simulate(100)
network_props = model.get_network_properties()
```

## 🎯 干预场景系统

### 场景类型 (`src/scenarios/`)

**1. 基线场景**:
```python
from src.scenarios.baseline import BaselineScenario

scenario = BaselineScenario()
results = scenario.run_simulation(120)
metrics = scenario.get_metrics(results)
```

**2. 接触减少场景**:
```python
from src.scenarios.interventions import ContactReductionScenario

# 30%接触减少
scenario = ContactReductionScenario(reduction_percent=0.30)
results = scenario.run_simulation(120)
# 效果: 感染峰值减少44%
```

**3. 快速隔离场景**:
```python
from src.scenarios.interventions import FasterIsolationScenario

# 恢复率提高50%
scenario = FasterIsolationScenario(gamma_multiplier=1.5)
results = scenario.run_simulation(120)
# 效果: 感染峰值减少35%
```

**4. 疫苗接种场景**:
```python
from src.scenarios.interventions import VaccinationScenario

# 40%人口预免疫
scenario = VaccinationScenario(vaccination_rate=0.40)
results = scenario.run_simulation(120)
# 效果: 感染峰值减少77%
```

**5. 组合干预场景**:
```python
from src.scenarios.interventions import CombinedInterventionScenario

scenario = CombinedInterventionScenario()
results = scenario.run_simulation(120)
# 效果: 感染峰值减少99.3%
```

## 📊 分析与指标系统

### 核心指标计算 (`src/analysis/metrics.py`)

```python
from src.analysis.metrics import calculate_all_metrics, compare_scenarios

# 单场景指标
metrics = calculate_all_metrics(results, N=10000)

# 关键指标
print(f"感染峰值比例: {metrics['peak_infection_proportion']:.3f}")
print(f"峰值时间: {metrics['time_to_peak']:.0f} 天")
print(f"最终疫情规模: {metrics['final_epidemic_size']:.3f}")
print(f"疫情持续时间: {metrics['epidemic_duration']:.0f} 天")

# 多场景对比
scenario_results = {
    '基线': baseline_results,
    '接触减少': contact_reduction_results,
    '疫苗接种': vaccination_results
}

comparison_df = compare_scenarios(scenario_results, N=10000)
print(comparison_df)
```

### 敏感性分析 (`src/analysis/sensitivity.py`)

```python
from src.analysis.sensitivity import SensitivityAnalyzer

# 创建分析器
analyzer = SensitivityAnalyzer(base_params={
    'N': 10000, 'beta': 0.30, 'gamma': 0.10, 'I0': 10, 'R0': 0
})

# β参数敏感性
beta_range = [0.15, 0.20, 0.25, 0.30, 0.35, 0.40]
beta_analysis = analyzer.analyze_parameter('beta', beta_range)

# 综合敏感性分析
comprehensive = analyzer.comprehensive_sensitivity_analysis()
```

## 🎨 可视化系统

### 基础绘图 (`utils/visualization.py`)

```python
from utils.visualization import (
    plot_sir_timeseries, plot_seir_timeseries,
    plot_infection_comparison, plot_metrics_comparison
)

# SIR时间序列图
fig = plot_sir_timeseries(sir_results, "SIR模型动态")
plt.show()

# 场景对比图
fig = plot_infection_comparison(scenario_results, "干预效果对比")
plt.show()

# 指标对比图
fig = plot_metrics_comparison(comparison_df, "关键指标对比")
plt.show()
```

## 🔧 手动运行示例

### 完整工作流程

```python
#!/usr/bin/env python3
"""完整的手动运行示例"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from src.models.sir_model import SIRModel
from src.models.hybrid_model import HybridEpidemicModel
from src.scenarios.interventions import ContactReductionScenario
from src.analysis.metrics import compare_scenarios
from utils.visualization import plot_infection_comparison

def complete_analysis():
    """完整分析流程"""
    
    # 1. 基础模型对比
    print("=== 基础模型对比 ===")
    sir_model = SIRModel(N=10000, beta=0.30, gamma=0.10, I0=10)
    sir_results = sir_model.simulate(120)
    
    hybrid_model = HybridEpidemicModel(N=10000, base_beta=0.30, base_gamma=0.10, I0=10)
    hybrid_results = hybrid_model.simulate(120)
    
    print(f"标准SIR峰值: {sir_results['I_prop'].max():.3f}")
    print(f"混合模型峰值: {hybrid_results['aggregate_results']['I_prop'].max():.3f}")
    
    # 2. 干预场景分析
    print("\n=== 干预场景分析 ===")
    scenarios = {
        '基线': sir_results,
        '混合模型': hybrid_results['aggregate_results'],
        '接触减少30%': ContactReductionScenario(0.30).run_simulation(120)
    }
    
    # 3. 生成对比分析
    comparison_df = compare_scenarios(scenarios, 10000)
    print(comparison_df)
    
    # 4. 可视化
    fig = plot_infection_comparison(scenarios, "完整对比分析")
    plt.savefig('complete_analysis.png', dpi=300, bbox_inches='tight')
    plt.show()
    
    return scenarios, comparison_df

if __name__ == "__main__":
    scenarios, comparison = complete_analysis()
```

## 📱 Jupyter Notebook使用

### 主要分析笔记本 (`notebooks/main_analysis.ipynb`)

```python
# 在Jupyter中运行
import sys
sys.path.append('..')

# 导入所有模块
from src.models import *
from src.scenarios import *
from src.analysis import *
from utils.visualization import *

# 交互式分析
%matplotlib inline
plt.style.use('seaborn-v0_8')

# 运行完整分析
# ... (详细分析代码)
```

### 快速测试笔记本 (`notebooks/quick_test.ipynb`)

用于快速验证功能和参数调试。

## 📁 输出文件说明

### 运行后生成的文件

**数据文件**:
- `data/demo_results.csv` - 主演示结果
- `data/scenario_comparison.png` - 场景对比图
- `data/sir_sensitivity_summary.csv` - SIR敏感性分析
- `data/seir_sensitivity_summary.csv` - SEIR敏感性分析

**可视化文件** (运行`run_all_visualizations.py`后):
- `all_visualizations/01_basic_models.png` - 基础模型对比
- `all_visualizations/02_intervention_scenarios.png` - 干预场景
- `all_visualizations/03_intervention_metrics.png` - 效果指标
- `all_visualizations/04_hybrid_innovation.png` - 混合模型创新
- `all_visualizations/05_sensitivity_analysis.png` - 敏感性分析
- `all_visualizations/06_network_models.png` - 网络模型对比
- `all_visualizations/07_summary_dashboard.png` - 综合仪表板

## 🎯 关键发现与结果

### 主要研究结果

1. **接触减少效果**: 30%接触减少 → 44%峰值降低
2. **快速隔离效果**: 50%恢复率提升 → 35%峰值降低
3. **疫苗接种效果**: 40%预免疫 → 77%峰值降低
4. **组合干预效果**: 多重干预 → 99.3%峰值降低
5. **混合模型创新**: 空间异质性 + 行为适应 → 49%额外峰值降低

### 创新模型优势

- **现实性**: 考虑空间异质性和人群行为
- **动态性**: 实时风险感知和适应
- **政策相关性**: 提供差异化干预建议
- **可扩展性**: 支持多种网络拓扑和参数设置

## 🔍 故障排除

### 常见问题

**1. 导入错误**:
```bash
# 确保在项目根目录运行
cd /path/to/project
python demo.py
```

**2. 可视化问题**:
```python
# 设置matplotlib后端
import matplotlib
matplotlib.use('Agg')  # 服务器环境
```

**3. 内存不足**:
```python
# 减少模拟规模
model = SIRModel(N=1000)  # 而不是10000
```

## 📚 扩展使用

### 自定义场景

```python
class CustomScenario:
    def __init__(self, custom_param):
        self.custom_param = custom_param
    
    def run_simulation(self, days=120):
        # 自定义模拟逻辑
        model = SIRModel(beta=self.custom_param)
        return model.simulate(days)
    
    def get_metrics(self, results):
        # 自定义指标计算
        return calculate_all_metrics(results, 10000)
```

### 参数优化

```python
from scipy.optimize import minimize

def objective_function(params):
    """优化目标函数"""
    beta, gamma = params
    model = SIRModel(N=10000, beta=beta, gamma=gamma, I0=10)
    results = model.simulate(120)
    return results['I_prop'].max()  # 最小化峰值

# 运行优化
result = minimize(objective_function, [0.3, 0.1], 
                 bounds=[(0.1, 0.5), (0.05, 0.2)])
```

## 🏆 项目总结

这个流行病学建模项目通过创新的混合空间-行为模型，实现了从传统SIR/SEIR模型到现实复杂系统建模的重大突破。项目不仅提供了完整的建模工具链，还为疫情防控政策制定提供了科学依据和量化支持。

**核心价值**:
- 🔬 **科学价值**: 方法学创新和理论贡献
- 🏛️ **政策价值**: 为公共卫生决策提供支持
- 🛠️ **工程价值**: 完整的开源建模框架
- 📚 **教育价值**: 优秀的教学和学习资源

---

*最后更新: 2024年10月*
*项目版本: v1.0*
*作者: [项目团队]*
